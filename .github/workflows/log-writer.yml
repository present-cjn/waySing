name: Daily Log Writer

on:
  issues:
    types: [opened] # å½“æœ‰æ–°çš„Issueè¢«åˆ›å»ºæ—¶è§¦å‘

jobs:
  write-log:
    # åªæœ‰è¢«æ‰“ä¸Š 'daily-log' æ ‡ç­¾çš„Issueæ‰è¿è¡Œ
    if: contains(github.event.issue.labels.*.name, 'daily-log')
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æ–‡ä»¶çš„æƒé™
      issues: write   # éœ€è¦å…³é—­Issueçš„æƒé™
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Append to Log File
        run: |
          import os
          from datetime import datetime

          issue_body = os.getenv('ISSUE_BODY')

          # ä» Issue Body ä¸­è§£æå‡ºè¡¨å•å†…å®¹
          challenge_id = issue_body.split('### é€‰æ‹©æŒ‘æˆ˜')[1].splitlines()[2].strip()
          status = issue_body.split('### ä»Šæ—¥çŠ¶æ€')[1].splitlines()[2].strip()
          reflection = issue_body.split('### å¿ƒå¾—ä¸åæ€')[1].split('</details>')[0].splitlines()[2:]
          reflection_text = "\n".join(reflection).strip()

          # æ‰¾åˆ°å¯¹åº”çš„LOG.mdæ–‡ä»¶
          log_file = f"challenges/{challenge_id}/LOG.md"

          # è¯»å–LOG.mdï¼Œç¡®å®šæ˜¯ç¬¬å‡ å¤©
          with open(log_file, 'r', encoding='utf-8') as f:
              content = f.read()
          day_count = len(re.findall(r"##\s+Day\s+\d+", content))
          new_day = day_count + 1

          # å‡†å¤‡è¦è¿½åŠ çš„æ–°æ—¥å¿—å†…å®¹
          today_str = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
          new_log_entry = f"\n---\n## Day {new_day}: {today_str}\n**çŠ¶æ€:** {status}\n\n**å¿ƒå¾—ä¸åæ€:**\n{reflection_text}\n"

          # è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
          with open(log_file, 'a', encoding='utf-8') as f:
              f.write(new_log_entry)

          print(f"Successfully appended to {log_file}")
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(log): âœï¸ Add new daily log entry"
          file_pattern: 'challenges/**/*.md'

      - name: Close the issue
        uses: peter-evans/close-issue@v3
        with:
          comment: "ğŸ“ æ„Ÿè°¢è®°å½•ï¼æ—¥å¿—å·²è‡ªåŠ¨å½’æ¡£ï¼Œæ­¤Issueå·²å…³é—­ã€‚"